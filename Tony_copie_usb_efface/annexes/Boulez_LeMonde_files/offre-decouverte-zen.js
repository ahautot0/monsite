define(function(require){var $=require("jquery");var storage=require("lmd/core/storage");var lectureZen=require("lmd/ui/lecture-zen");var Lightbox=require("lmd/ui/lightbox");var service=require("lmd/core/service");var auth=require("lmd/core/auth");var popinTemplate=require("hoganpower!/partials/layout/tracking/decouverte_zen_register.html.mu@www");var today=(new Date).getTime();var messages={erreurs:{generique:"Une erreur s\u2019est produite. Veuillez v\u00e9rifier les renseignements fournis.",nom:"<strong>Merci de renseigner votre </strong>Nom",
prenom:"<strong>Merci de renseigner votre </strong>Pr\u00e9nom",email:"<strong>Merci de renseigner votre </strong>Adresse e-mail",emailIncorrect:"Adresse email incorrecte."},erreursParticipation:{dejaJoueMemeOperation:["Vous avez d\u00e9j\u00e0 profit\u00e9 de cette offre d\u00e9couverte, ","vous ne pouvez en profiter \u00e0 nouveau.<br /> ","Pour retrouver tous les services abonn\u00e9s, ",'<a href="https://wwws.lemonde.fr/abonnement/achat.html#TUNNELDECOUV14">',"abonnez-vous \u00e0 partir de 1\u20ac.</a>"].join(""),
dejaJoueMax:["Vous avez d\u00e9j\u00e0 profit\u00e9 \u00e0 deux reprises de l\u2019offre d\u00e9couverte Le Monde.fr","<br />Pour b\u00e9n\u00e9ficier de tous les services abonn\u00e9s, ",'<a href="https://wwws.lemonde.fr/abonnement/achat.html#TUNNELDECOUV14">',"abonnez-vous \u00e0 partir de 1\u20ac</a>"].join(""),max_participation:"Vous ne pourrez plus b\u00e9n\u00e9ficier de l\u2019offre d\u00e9couverte",dejaAbonne:["Vous b\u00e9n\u00e9ficiez d\u00e9j\u00e0 d\u2019un acc\u00e8s a l\u2019\u00c9dition abonn\u00e9s avec cette adresse e-mail.",
"Vous pouvez vous authentifier avec vos identifiants habituels."].join("<br />"),erreurAbo:"Une erreur est survenue lors de votre abonnement"}};var xitiTagPrefix="Inscription_offre_decouverte::Lemondefr::";var hit={med:function(tag){xt_med("F","19",xitiTagPrefix+tag)},form:function(form,tag){xt_form(form,"C","19",xitiTagPrefix+tag,"A",false)}};var lightbox={overlay:".fond_overlay.offre_decouverte",wrapper:".overlay.offre_decouverte",button:".js_fermer_offre_decouverte",top:85,overlayClose:false,overlaySpeedIn:250,
overlaySpeedout:250};var services={eligibility_check:"marketing/decouverte/check",sign_up:"marketing/decouverte/abo"};var discoveryParams={};var odzSingleton;var OffreDecouverteZen=function(){var self=this;if(document.location.pathname==="/")return;if(lmd.conf.decouverte_no_count.indexOf(document.location.pathname)>=0)return;if(document.location.pathname===lmd.conf.url_teaser_ex_decouverte)return;if(typeof window.screen!=="undefined"&&typeof window.screen.width!=="undefined"&&window.screen.width<
699)return;auth.loadUser().done(function(){if(!auth.authenticated||!auth.user.abonne)self.init()})};OffreDecouverteZen.prototype={init:function(){var self=this;self.subscriptionPromise=$.Deferred();self.initWelcomePack()},initWelcomePack:function(){var self=this;var views=storage.get("lmd_decouverte_cpt")||{page_count:0,already_shown:false,url:""};var period=12096E5;var exAbo=storage.get("lmd_decouverte")||{};if(views.url!==document.location.href&&!views.already_shown){var pageViewLimitReached=false;
var isArticle=!!lmd.context.item&&lmd.context.item.type!==undefined&&lmd.context.item.type.nom!==undefined&&lmd.context.item.type.nom==="article";views.url=document.location.href;views.page_count++;pageViewLimitReached=views.page_count>=parseInt(lmd.conf.limit_wall);if(pageViewLimitReached&&isArticle){views.already_shown=true;self.operation_id=lmd.conf.offre_decouverte_avec_abo_auto;self.afficherLectureZen()}storage.set("lmd_decouverte_cpt",views,period)}if(lectureZen.getInstance().bouton)lectureZen.getInstance().bouton.addClass("btn_offre_decouverte_zen").on("click",
function(){self.boutonLectureZenXiti();self.operation_id=lmd.conf.offre_decouverte_zen_avec_abo_auto;self.afficherLectureZen()})},afficherLectureZen:function(){var self=this;lectureZen.getInstance().open(function(){lectureZen.getInstance().lightbox.instance.disableClosing=true;var count=0;var interval=setInterval(function(){count+=1E3;if(count>=lmd.conf.decouverte_zen_delay){self.afficherFormulaire();clearInterval(interval)}},1E3)})},afficherFormulaire:function(operation_id,operation_classname,template){var self=
this;var tpl=template||popinTemplate;this.lightbox=new Lightbox(lightbox);this.lightbox.setLoader(true);this.lightbox.on("open",function(){if(lectureZen.getInstance().lightbox)lectureZen.getInstance().lightbox.instance.disableClosing=false;require(["lmd/core/metrics/tradelab"],function(tradelab){tradelab.addScript("noAboZenPopin")});self.setupFormulaire();self.loadXiti();$("#decouverte #no_thanks").click(function(){self.lightbox.close()})});this.lightbox.on("close",function(){if((!auth.authenticated||
!auth.user.abonne)&&lectureZen.getInstance().lightbox)lectureZen.getInstance().lightbox.close();else lectureZen.getInstance().loadXiti()});discoveryParams=self.getDiscoveryParams();this.lightbox.open(tpl.render({conf:lmd.conf,operation_id:operation_id||self.operation_id,popin_class:operation_classname||discoveryParams.popinClass}))},setupFormulaire:function(){var self=this;self.subscriptionPromise=self.subscriptionPromise||$.Deferred();$("#decouverte input").on("focus change",function(){$(this).removeClass("saisie_erreur")});
$("#decouverte").on("submit",function(event){event.preventDefault();var url_creation_compte=services.sign_up;$("#decouverte #erreur").hide();var spinner=(new Spinner({radius:5,length:5,width:2})).spin();$("#decouverte #submit").append($(spinner.el).css({top:-20,left:375}));self.checkFormulaire().then(function(){service.get(url_creation_compte,2,{email:$("#decouverte #email").val(),nom:$("#decouverte #nom").val(),prenom:$("#decouverte #prenom").val(),operation_id:$("#decouverte #operation_id").val(),
optin:$("#decouverte #optin").is(":checked"),abort_id:discoveryParams.operationId},{timeout:15E3}).done(function(data){if(!data.msg){self.hitXiti();self.poserParticipation(true);self.subscriptionPromise.resolve();window.location.href=self.getSubscriptionUrl()}else{var error="";switch(data.msg){case "4000":error=messages.erreursParticipation.dejaAbonne;break;case "4400":error=messages.erreursParticipation.dejaJoueMax;break;default:error=messages.erreursParticipation.erreurAbo;break}$("#decouverte #erreur").html(error).show();
self.subscriptionPromise.reject(error)}spinner.stop()}).fail(function(){$("#decouverte #erreur").html(messages.erreurs.generique).show();self.subscriptionPromise.reject(messages.erreurs.generique);spinner.stop()})},function(errors){$("#decouverte #erreur").html(errors.join("<br />")).show();self.subscriptionPromise.reject(errors.join("<br />"));spinner.stop()})})},getSubscriptionUrl:function(){return["https://",lmd.conf.wwws.location.hostname,"/abonnement/achat.html","?key=",discoveryParams.marketingKey,
"&email=",encodeURIComponent($("#decouverte #email").val()),$("#decouverte #optin").is(":checked")?"&optin=1":""].join("")},checkFormulaire:function(){var promise=new $.Deferred;service.get(services.eligibility_check,1,{email:$("#decouverte #email").val(),operation_id:$("#decouverte #operation_id").val()}).done(function(data){if(data.participation==="max_participation"){$("#decouverte #max_participation").attr("value","max_participation");promise.resolve("max_participation")}else if(data.participation!==
null){$("#decouverte #max_participation").attr("value","");promise.reject([messages.erreursParticipation[data.participation]])}else{$("#decouverte #max_participation").attr("value","");promise.resolve()}}).fail(function(response){var res=JSON.parse(response.responseText);promise.reject([messages.erreurs.generique,res.error.clientMessage])});return promise},loadXiti:function(){var self=this;switch(self.operation_id){case lmd.conf.offre_decouverte_avec_abo_auto:hit.med("Affichage_formulaire");break;
case lmd.conf.offre_decouverte_zen_avec_abo_auto:hit.med("Affichage_formulaire_bouton_lecture_zen");break}},hitXiti:function(){var self=this;var form=document.getElementById("decouverte");switch(self.operation_id){case lmd.conf.offre_decouverte_avec_abo_auto:hit.form(form,"Validation_formulaire");break;case lmd.conf.offre_decouverte_zen_avec_abo_auto:return hit.form(form,"Validation_formulaire_bouton_lecture_zen")}},boutonLectureZenXiti:function(){xt_click(lectureZen.getInstance().bouton.get(0),"C",
"19","Offre_decouverte::Lemonde.fr::Bouton_lecture_zen","A")},poserParticipation:function(abo){var expire_ts=5184E6;var date_fin_abo=today+2592E6;var user_cookie={is_abo:true,participation:today,date_abo:null,date_fin:date_fin_abo};if(abo)user_cookie.date_abo=today;storage.set("lmd_decouverte",user_cookie,expire_ts,false)},logUserIn:function(passwd){var self=this;var user={login:$("#decouverte #email").val(),password:passwd,sauv_login:false};auth.login(user,true).done(function(response){if(response.result)auth.loadUser(true).done(function(){$("#decouverte #confirmation").show();
setTimeout(function(){self.lightbox.close();self.showHelp()},3E3);lectureZen.getInstance().lightbox.on("close",function(){window.location.reload()})})})},showHelp:function(){var popin=$(['<div class="conteneur_popinbox_wrapper">','<div class="conteneur_popinbox"></div>','<div class="popin">',"Cliquez ici pour quitter la lecture zen","</div></div>"].join(""));$(".fermer_lecture_zen").append(popin)},getDiscoveryParams:function(){var self=this;var config=JSON.parse(lmd.conf.decouverte_cb);switch(self.operation_id){case lmd.conf.offre_decouverte_avec_abo_auto:return config.pages;
case lmd.conf.offre_decouverte_zen_avec_abo_auto:return config.zen}}};odzSingleton=new OffreDecouverteZen;return{getInstance:function(){return odzSingleton}}});
