/**
 * Package www/dispatcher
 * lmd/module/priority-dispatcher
 * lmd/data/meter
 * lmd/core/ux/outbrain
 * lmd.meter
 */

/* -- start module lmd/module/priority-dispatcher -- */
define("lmd/module/priority-dispatcher",function(require){var $=require("jquery");var meterModule=require("lmd/data/meter");var mods={meter:meterModule.isEnabled()&&meterModule.maxReached()};var syncState=new $.Deferred;var dependents={outbrain:["meter"]};var disabled=[];var addActive=function(state){if(state.active)disabled.push(state.name)};(function(forin,once){var i=0;var len=0;var waiting=[];var modState;forin(dependents,function(candidate,priorityModules){waiting=[];for(i=0,len=priorityModules.length;i<len;i++){modState=mods[priorityModules[i]];
if(typeof modState==="object"){waiting.push(modState);modState.done(addActive)}else{addActive({active:modState,name:candidate});break}}});once(waiting).then(function(){syncState.resolve(disabled)})})($.each,$.when);return syncState});

/* -- end module lmd/module/priority-dispatcher -- */
/* -- start module lmd/data/meter -- */
define("lmd/data/meter",function(require){var conf=require("lmd/core/conf");var context=require("lmd/core/context");var storage=require("lmd/core/storage");var objectPath=require("lib/object-path");var consts={readItemKey:"us_meter_readed",activatedKey:"us_meter_activation",simulationKey:"us_meter_simulation"};var isSimulated=function(){return storage.get(consts.simulationKey)!==null};var quota=objectPath.get(conf,"us_meter.quota_per_month")||1E3;var PublicInterface=function(){this.isEnabled=function(){var active=
false;this.isEnabled=function(){return active};if(isSimulated())active=true;else if(objectPath.get(conf,"fsw.us_meter")&&storage.get(consts.activatedKey)!==null)active=true;if(active)active=function(){var application=objectPath.get(conf,"us_meter.application")||[];var pageType=objectPath.get(conf,"us_meter.page_type")||[];return application.indexOf(context.application)>-1&&pageType.indexOf(context.pageType)>-1}();return active};this.maxReached=function(){return!!(this.readItemIds&&this.readItemIds.length>=
quota)};this.keys=consts;this.readItemIds=JSON.parse(storage.get(consts.readItemKey))||[];this.isSimulated=isSimulated;return this};return new PublicInterface});

/* -- end module lmd/data/meter -- */
/* -- start module lmd/core/ux/outbrain -- */
define("lmd/core/ux/outbrain",function(require){var context=require("lmd/core/context");var conf=require("lmd/core/conf");var objectPath=require("lib/object-path");var depends=require("lmd/module/priority-dispatcher");var hostname="www.lemonde.fr";var link=objectPath.get(lmd,"context.page.link");var load=function(){var oubtrain=document.createElement("script");oubtrain.async=true;oubtrain.src="//widgets.outbrain.com/outbrain.js";(document.getElementsByTagName("head")[0]||document.getElementsByTagName("body")[0]||document.getElementsByTagName("script")[0].parentNode).insertBefore(oubtrain,
null)};var loadConditional=function(){var i=0;var j;var doLoadOb=true;var sections;if(conf.featureSectionBlacklist.outbrain){sections=context.getSectionNameList();for(j=sections.length;i<j;i++)if(conf.featureSectionBlacklist.outbrain.indexOf(sections[i])!==-1){doLoadOb=false;break}}if(doLoadOb)depends.done(function(blacklisted){if(blacklisted.indexOf("outbrain")===-1)load()});return doLoadOb};var loadIf=function(){if(!lmd.conf.fsw.outbrain||!(lmd.context.pageType==="Element"||lmd.context.pageType===
"Rubrique"||lmd.context.pageType==="Rubrique_Une"))return function(){return false};return loadConditional};function getTag(tag){if(tag.id===undefined||!optionsChecked(tag.options))return;var html=document.createElement("div");html.setAttribute("class","OUTBRAIN");html.setAttribute("data-src","http://"+hostname+link);html.setAttribute("data-widget-id",tag.id);html.setAttribute("data-ob-template","lemonde");return html}function optionsChecked(options){if(!options)return true;if(options.minWidth||options.maxWidth){var w=window.innerWidth||
document.documentElement.clientWidth||document.body.clientWidth;if(options.minWidth&&options.minWidth>w)return false;if(options.maxWidth&&options.maxWidth<=w)return false}return true}var insertTags=function(id,tags,autoload){var elmt=document.getElementById(id);if(elmt.length===0)return;var isWidget=false;var numTags=tags.length;var t=0;for(;t<numTags;t++){var html=getTag(tags[t]);if(html){elmt.appendChild(html);isWidget=true}}if(!isWidget)cleanUp(elmt);if(isWidget&&autoload!==false)loadConditional()};
var cleanUp=function(domElt){var parent=domElt.parentNode;parent.removeChild(domElt)};return{load:loadIf(),insertTags:function(){if(!lmd.conf.fsw.outbrain||!link)return function(eltId){cleanUp(document.getElementById(eltId));return false};else return insertTags}()}});

/* -- end module lmd/core/ux/outbrain -- */
/* -- start module lmd.meter -- */
define("lmd.meter",function(require){require("hoganpower");var $=require("jquery");var conf=require("lmd/core/conf");var context=require("lmd/core/context");var service=require("lmd/core/service");var storage=require("lmd/core/storage");var states=require("lmd/data/meter");var objectPath=require("lib/object-path");var isWww=context.application==="www";var templateToaster=require("hoganpower!/templates/module/meter/toaster.html.mu");var templateWall=require("hoganpower!/templates/module/meter/wall.html.mu");var quota=
objectPath.get(conf,"us_meter.quota_per_month")||1E3;var isSimulated=states.isSimulated();return{launch:launch,simulate:simulate};function launch(){loadMeter();if(!states.isEnabled())return;if(states.maxReached())displayWall();else{displayArticle();storeItem();displayToaster()}}function displayArticle(){var id=objectPath.get(context,"element.id");var pageType=objectPath.get(context,"pageType");var elementType=objectPath.get(context,"element.type.nom");var isRestricted=objectPath.get(context,"element.restreint");
if(/^\d+$/.test(id)&&pageType==="Element"&&elementType==="article"&&isRestricted===true){var url=["overlay",id,"us_meter"].join("/");var params={dataType:"json",timeout:1E4};service.get(url,1,{},params).then(function(json){$(".js_article_body").html(json.element);$(".js_teaser_article").detach()})}}function displayToaster(){var displayAt=objectPath.get(conf,"us_meter.display_toaster");var readNumber=lmd.usMeter.readItemIds.length.toString();var limit=quota.toString();var toasterNumber=displayAt.indexOf(readNumber)+
1;if(displayAt.indexOf(readNumber)>-1||parseInt(limit,10)===parseInt(readNumber,10)){if(objectPath.get(conf,"fsw.us_meter_display")===true){$("body").append(templateToaster.render({readNumber:readNumber,limit:limit,isLast:parseInt(readNumber,10)>=parseInt(limit,10),key:isWww?"TOASTERWEB":"TOASTERMOB",step:toasterNumber}));$(".js_meter_toaster").on("click",".bt_fermer_rond",function(){$(".js_meter_toaster").remove()})}doTrackingHit("Affichage_Toaster::affichage_"+toasterNumber);doTrackXtView("INT-43-"+
toasterNumber)}}function displayWall(){var limit=quota.toString();if(objectPath.get(conf,"fsw.us_meter_display")===true){$(".js_meter_global").append(templateWall.render({limit:limit,key:isWww?"PAYWALLWEB":"PAYWALLMOB"}));$(window).scrollTop(0);$("#video_container").remove()}doTrackingHit("Affichage_wall");doTrackXtView("INT-42")}function loadMeter(){window.lmd=lmd||{};window.lmd.usMeter={activated:states.isEnabled(),simulated:states.isSimulated(),readItemIds:states.readItemIds}}function simulate(activation){if(activation===
true){isSimulated=true;storage.set(states.keys.simulationKey,true);console.debug("US Meter simulation activated")}else{isSimulated=false;storage.remove(states.keys.simulationKey);console.debug("US Meter simulation desactivated")}loadMeter()}function storeItem(){window.lmd=lmd||{};lmd.usMeter.readItemIds=lmd.usMeter.readItemIds||[];if(lmd.usMeter.readItemIds.indexOf(context.item.id)===-1&&states.isEnabled()){lmd.usMeter.readItemIds.push(context.item.id);storage.set(states.keys.readItemKey,JSON.stringify(lmd.usMeter.readItemIds),
dataTimeout())}}function doTrackingHit(clickName){if(typeof window.xt_med==="function")window.xt_med("C","",clickName,"A")}function dataTimeout(){var now=new Date;var lastDay=new Date(now.getFullYear(),now.getMonth()+1,0,23,59,59);return lastDay-now}function doTrackXtView(id){var url="http://logc2.xiti.com/get.ad?xts=43260&ati="+id+"&type=AT&z="+(new Date).getTime();$("<img/>").appendTo("body").attr("src",url)}});

/* -- end module lmd.meter -- */
